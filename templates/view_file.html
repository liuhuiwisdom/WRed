<html>
<head>
  <title>FileViewer</title>
  <link rel="stylesheet" type="text/css" href="/media/JavaScript/ext-3.2.1/resources/css/ext-all.css" />
  <script type="text/javascript" src="/media/JavaScript/ext-3.2.1/adapter/ext/ext-base.js"></script>
  <script type="text/javascript" src="/media/JavaScript/ext-3.2.1/ext-all.js"></script>
  <script type="text/javascript" src="/media/JavaScript/jquery-1.4.2/jquery-1.4.2.js"></script>
<script type="text/javascript" src="/media/JavaScript/flot-0.6/jquery.js"></script>
<!-- FOR IE <script type="text/javascript" src="./flot/excanvas.js"></script> -->
<script type="text/javascript" src="/media/JavaScript/flot-0.6/jquery.flot.js"></script>
<script src="/media/JavaScript/flot-0.6/jquery.flot.errorbars.js" type="text/javascript" language="javascript"></script>
  <script>
Ext.onReady(function(){
    

    // NOTE: This is an example showing simple state management. During development,
    // it is generally best to disable state management as dynamically-generated ids
    // can change across page loads, leading to unpredictable results.  The developer
    // should ensure that stable state ids are set for stateful components in real apps.    
    Ext.state.Manager.setProvider(new Ext.state.CookieProvider());

    var dataArray = [];
    function update(){
        var fieldData = dataArray[0];
        dataArray.splice(0,1);
        var gridColumns = [];
        var storeFields = [];
        for(var i = 0; i < fieldData.length; ++i){
            gridColumns.push({header: fieldData[i], width: 70, sortable: true, dataIndex: fieldData[i]});
            storeFields.push({name: fieldData[i]});
        }

        var store = new Ext.data.ArrayStore({
            fields: storeFields,
        });

        // create the data store
    
        store.loadData(dataArray);
        // create the Grid
        var grid = new Ext.grid.GridPanel({
            store: store,
            columns: gridColumns,
            stripeRows: true,
            height: 300,
            autoWidth:true,
            //autoHeight:true,
            title: 'File Data',
            horizontalScroll: true,
            // config options for stateful behavior
            //stateful: true,
            //stateId: 'grid'        
        });
        var commonChartStyle = {"margin": "10px 10px 10px 10px"};


    var xChoice = new Ext.form.ComboBox({
        fieldLabel: 'X Axis',
        hiddenName: 'xchoice',
        store: fieldData,
        typeAhead: true,
        mode: 'local',
        triggerAction: 'all',
        emptyText:'X Axis...',
        selectOnFocus:true,
        listeners:{select:{fn:selection}},
    });
    var yChoice = new Ext.form.ComboBox({
        fieldLabel: 'Y Axis',
        hiddenName: 'ychoice',
        store:fieldData,
        typeAhead: true,
        mode: 'local',
        triggerAction: 'all',
        emptyText:'Y Axis...',
        selectOnFocus:true,
        listeners:{select:{fn:selection}},
    });

    var ChartContainer = new Ext.Panel({
        height: 500,
        width: 500,
        style: commonChartStyle,
        id: 'ChartContainer',
    });
    var ChartTab = new Ext.Panel({
        title:'Chart',
        autoWidth:true,
        autoHeight:true,
        id: 'ChartTab',
        items: [xChoice, yChoice, ChartContainer],
    });
        var tabs = new Ext.TabPanel({
           renderTo: 'tabs',
           activeTab:0,
           defaults:{autoHeight: true, autoWidth: true},
           //width:900,
           //height:900,
           layoutOnTabChange:true,
        });
    tabs.add({
        id:'file',
        title: "View File",
        //xtype:"panel",
        items:[grid],
    }).show();
    tabs.add({
        listeners:{activate:handleActivate},
        id:'chart',
        title:"View Chart",
        items:[ChartTab],
    })
        // render the grid to the specified div in the page
        tabs.render();
function handleActivate(tab){
    drawChart(store, 'A4','Detector', 'ChartContainer');
}
function selection(selectedstore, value){
    drawChart(store, xChoice.getValue(), yChoice.getValue(), 'ChartContainer');
}
    }
    function cb(data){
        dataArray = data;
        update();
    }
    var jsonpoints = jQuery.getJSON('json/{{ params.md5 }}', cb);
    //drawChart(store, 'A4','Detector', 'ChartContainer');
});
function getData(store, xcol, ycol) {
    var dataResults = [];

    for( var recordIndex = 0; recordIndex < store.getCount(); recordIndex++ ) {
        var record = store.getAt(recordIndex);
        var data = [record.get(xcol), record.get(ycol), Math.sqrt(record.get(ycol))];
        dataResults.push(data);
    }
    return dataResults;
}

function drawChart(store, xcol, ycol, chart) {
    var chartInfo = getData(store, xcol, ycol);
    var data_points = {errorbars: "y",
        yerr: {show:true, upperCap: "-", lowerCap: "-"}};
    // 3: draw the chart in the container
    var options = {series:{points:{show:true, radius:3}}}
    $.plot($("#"+chart), [{data: chartInfo, points:data_points, lines:{show:false}}], options);
}
</script>
</head>
<body>
    <h3>View Some Files</h3>
    <div id = "tabs"></div>
</body>
</html>
